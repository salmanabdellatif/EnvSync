generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String?   // bcrypt hashed (null for OAuth users)
  name            String
  avatar          String?
  
  oauthProviders  OAuthProvider[] // connected accounts
  
  // Email verification (only for email+password signups)
  emailVerified   Boolean   @default(false)
  verifyToken     String?   @unique  // Token sent via email
  verifyTokenExp  DateTime? // Token expiration

  // Password reset
  resetToken      String?   @unique
  resetTokenExp   DateTime?
  
  // 2FA (V2)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  // TOTP secret for authenticator apps
  
  // E2E Encryption
  publicKey        String?  // User's public key (RSA/ECC) for E2E encryption

  // The Backup Package (For the user's eyes only)
  encryptedPrivateKey String? 
  encryptionSalt      String?  // Salt B
  encryptionIV        String?  // Needed for AES decryption
  encryptionAuthTag   String?  // GCM auth tag for integrity

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  ownedProjects   Project[]       @relation("OwnedProjects")
  memberships     ProjectMember[]
  apiKeys         ApiKey[]
  sentInvites     Invitation[]    @relation("InviteSender")
  receivedInvites Invitation[]  @relation("InviteReceiver")
  createdVariables EnvVariable[] @relation("CreatedVars")
  updatedVariables EnvVariable[] @relation("UpdatedVars")
}

model OAuthProvider {
  id         String @id @default(cuid())
  userId     String
  provider   String   
  providerId String   
  createdAt  DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerId])
}

model Project {
  id           String   @id @default(cuid())
  name         String
  slug         String   
  ownerId      String   
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  owner        User            @relation("OwnedProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  members      ProjectMember[]
  environments Environment[]
  invitations  Invitation[]
  auditLogs    AuditLog[]
  
  @@unique([ownerId, slug])  // Unique per owner
}

enum Role {
  OWNER   // Full control, can delete project
  ADMIN   // Manage team, all envs
  MEMBER  // Edit assigned envs
  VIEWER  // Read only
}

model ProjectMember {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  role      Role     @default(MEMBER)
  joinedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wrappedKey String?  // Project key encrypted with user's public key (E2E)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  @@unique([userId, projectId]) // User can only be member once per project
}

model Environment {
  id        String       @id @default(cuid())
  name      String       // "development", "staging", "production"
  projectId String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  variables EnvVariable[]
  @@unique([projectId, name]) // One "development" per project
}

model EnvVariable {
  id             String      @id @default(cuid())
  key            String      // "DATABASE_URL"
  encryptedValue String      // AES-256-GCM ciphertext (base64)
  iv             String      // Initialization vector (base64)
  authTag        String      // GCM authentication tag (base64) - tamper detection
  
  comment    String?         // "# Database connection"

  environmentId  String
  environment    Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  createdBy      String      // User ID
  createdUser    User        @relation("CreatedVars", fields: [createdBy], references: [id])

  updatedBy      String      // User ID
  updatedUser    User        @relation("UpdatedVars", fields: [updatedBy], references: [id])
  
  @@unique([environmentId, key]) // One API_KEY per environment
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model Invitation {
  id          String       @id @default(cuid())
  email       String       // Can invite non-users
  projectId   String
  role        Role         @default(MEMBER)
  invitedById String
  inviteeId   String?      // Null if email not registered yet
  status      InviteStatus @default(PENDING)
  token       String       @unique @default(cuid())
  expiresAt   DateTime
  createdAt   DateTime     @default(now())
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invitedBy   User         @relation("InviteSender", fields: [invitedById], references: [id])
  invitee     User?        @relation("InviteReceiver", fields: [inviteeId], references: [id])
}

model ApiKey {
  id         String    @id @default(cuid())
  name       String    // "Work Laptop", "CI Server"
  keyHash    String    // bcrypt hash of full key
  keyPrefix  String    // "envsync_a8f3" (for display)
  userId     String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum AuditAction {
  // Variables
  VARIABLE_CREATED
  VARIABLE_UPDATED
  VARIABLE_DELETED
  VARIABLES_EXPORTED
  
  // Environment
  ENVIRONMENT_CREATED
  ENVIRONMENT_DELETED
  
  // Members
  MEMBER_INVITED
  MEMBER_JOINED
  MEMBER_REMOVED
  MEMBER_ROLE_CHANGED
  
  // Project
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_DELETED
}

model AuditLog {
  id        String      @id @default(cuid())
  action    AuditAction
  projectId String
  userId    String
  metadata  Json?       // { variableKey: "API_KEY", oldValue: "***", newValue: "***" }
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}